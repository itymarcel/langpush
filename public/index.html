<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lingua Push</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    #installBtn { display:none; padding:10px 14px; border:0; border-radius:10px; font-weight:600; }
    #iosTip { display:none; margin-top:10px; font-size:14px; }
  </style>
</head>
<body>
  <button id="installBtn">Install app</button>
  <div id="iosTip">On iPhone: open in Safari → <b>Share</b> → <b>Add to Home Screen</b>.</div>

  <button id="sub">Subscribe to notifications</button>

  <script>
    const btn = document.getElementById("sub");
    let reg; // service worker registration cache

    function setBtn(state) {
        if (state === "sub") { btn.textContent = "Unsubscribe"; btn.disabled = false; }
        else if (state === "unsub") { btn.textContent = "Subscribe to notifications"; btn.disabled = false; }
        else { btn.textContent = "…"; btn.disabled = true; }
    }

    async function readySW() {
        if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
        btn.textContent = "Push not supported"; btn.disabled = true; return null;
        }
        if (!reg) {
        await navigator.serviceWorker.register("/sw.js");
        reg = await navigator.serviceWorker.ready;
        }
        return reg;
    }

    async function getVapidKey() {
        return (await (await fetch("/vapidPublicKey")).text()).trim();
    }

    function toUint8(base64) {
        const pad = "=".repeat((4 - base64.length % 4) % 4);
        const b64 = (base64 + pad).replace(/-/g, "+").replace(/_/g, "/");
        const raw = atob(b64);
        return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
    }

    // ---- core: sync button label with actual state (SW + server)
    async function syncButton() {
        setBtn("…");
        const r = await readySW();
        if (!r) return;
        const sub = await r.pushManager.getSubscription();
        let existsOnServer = false;

        if (sub) {
        try {
            const q = new URLSearchParams({ endpoint: sub.endpoint }).toString();
            const resp = await fetch(`/subscribe/exists?${q}`);
            const json = await resp.json();
            existsOnServer = !!json.exists;
        } catch {}
        }

        setBtn(sub && existsOnServer ? "sub" : "unsub");
        return { sub, existsOnServer };
    }

    // ---- click handler toggles and then re-syncs
    btn.addEventListener("click", async () => {
        const r = await readySW(); if (!r) return;

        // refresh state at click time
        const { sub, existsOnServer } = await syncButton();

        // Unsubscribe flow
        if (sub && existsOnServer) {
        setBtn("…");
        const endpoint = sub.endpoint;
        try { await sub.unsubscribe(); } catch {}
        await fetch("/subscribe", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ endpoint })
        });
        await syncButton();
        return;
        }

        // Subscribe flow
        if (Notification.permission === "denied") {
        alert("Notifications are blocked. Enable them in your browser settings.");
        return;
        }

        try {
        setBtn("…");
        if (Notification.permission !== "granted") await Notification.requestPermission();
        const key = await getVapidKey();
        const newSub = await r.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: toUint8(key)
        });
        await fetch("/subscribe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newSub)
        });
        await syncButton();
        } catch (e) {
        console.error(e);
        setBtn("unsub");
        alert("Subscription failed.");
        }
    });

    // run once on load
    (async () => { await syncButton(); })();
    </script>

  <script src="/install.js" defer></script>
</body>
</html>
